<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operational Risk Management Form - VQ-4 Shadows</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Define arrays globally
        const humanFactors = [
            { id: 'q1', text: 'Cumulative fatigue from ≥4 duty days (≥12 hrs/day) in past 5 days', severity: 2 },
            { id: 'q2', text: 'Cumulative sleep debt (2+ nights w/ <6 hrs sleep in past 72 hrs)', severity: 3 },
            { id: 'q3', text: 'Circadian rhythm disruption (day ↔ night shift in past 48 hrs)', severity: 2 },
            { id: 'q4', text: 'Recent personal stressors', severity: 1 },
            { id: 'q5', text: 'First mission after ≥30-day non-flying period', severity: 1 },
            { id: 'q6', text: 'Any Crew Member not current', severity: 2 }
        ];

        const schedulingFactors = [
            { id: 'q7', text: 'Crew rest <12 hours', severity: 2 },
            { id: 'q8', text: 'Long sortie (>12 hour planned crew day)', severity: 2 },
            { id: 'q9', text: 'Planned crew day includes duty between 2200-0600', severity: 2 },
            { id: 'q10', text: 'Projected duty day ≥15 hrs (approaching 18-hour max)', severity: 3 },
            { id: 'q11', text: 'Crew scheduled to cross ≥2 time zones in 48-hr period', severity: 2 },
            { id: 'q12', text: 'Significant mission change after crew report time', severity: 2 },
            { id: 'q13', text: 'Crew scheduled without adequate recovery following night mission', severity: 2 }
        ];

        const missionFactors = [
            { id: 'q14', text: 'Op Area evolution', severity: 1 },
            { id: 'q15', text: 'Air Refueling', severity: 2 },
            { id: 'q16', text: 'Pilot Training Event (engine pulls)', severity: 3 },
            { id: 'q17', text: 'Closed Tower / Uncontrolled Field Ops', severity: 2 },
            { id: 'q18', text: 'R4305 Op Area', severity: 2 },
            { id: 'q19', text: 'Unfamiliar Airfield Ops', severity: 2 },
            { id: 'q20', text: 'Delayed Takeoff (mx, weather, etc...)', severity: 1 },
            { id: 'q21', text: 'Known degraded system(s) requiring crew workaround', severity: 2 },
            { id: 'q22', text: 'Crew augmentation not available', severity: 3 }
        ];

        const environmentalFactors = [
            { id: 'q23', text: 'Flying at night', severity: 2 },
            { id: 'q24', text: 'Departure weather <1500 ft ceiling and/or <3 sm visibility', severity: 2 },
            { id: 'q25', text: 'Enroute weather concerns (thunderstorms, icing, turbulence)', severity: 3 },
            { id: 'q26', text: 'Destination weather <1500 ft ceiling and/or <3 sm visibility', severity: 2 },
            { id: 'q27', text: 'Elevated bird/wildlife activity at departure/destination field', severity: 2 }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and script running');
            console.log('Document body:', document.body.innerHTML); // Debug DOM structure
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const totalScoreElement = document.getElementById('totalScore');
            const riskRankElement = document.getElementById('riskRank');
            const riskNoteElement = document.getElementById('riskNote');
            const gaugeFill = document.getElementById('gaugeFill');
            const submitButton = document.getElementById('submitData');
            const printButton = document.getElementById('printForm');

            if (!submitButton || !printButton) {
                console.error('Submit or Print button not found. Checking by class...');
                const submitButtons = document.getElementsByClassName('submit-btn');
                const printButtons = document.getElementsByClassName('print-btn');
                if (submitButtons.length > 0) submitButton = submitButtons[0];
                if (printButtons.length > 0) printButton = printButtons[0];
                if (!submitButton || !printButton) {
                    console.error('Buttons still not found. Available elements:', {
                        submitButton: submitButton,
                        printButton: printButton,
                        allButtons: document.getElementsByTagName('button')
                    });
                    return;
                }
            }
            console.log('Buttons found:', { submitButton, printButton });

            submitButton.addEventListener('click', () => {
                console.log('Submit button clicked');
                const acmc = document.getElementById('acmc').value.trim();
                const crew = document.getElementById('crew').value;
                const takeoffTime = document.getElementById('takeoffTime').value.trim();
                const acmcReviewYes = document.getElementById('acmcReviewYes').checked;
                const acmcReviewNo = document.getElementById('acmcReviewNo').checked;
                let isValid = true;

                if (!acmc) {
                    document.getElementById('acmcError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('acmcError').classList.add('hidden');
                }
                if (!crew) {
                    document.getElementById('crewError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('crewError').classList.add('hidden');
                }
                if (!takeoffTime) {
                    document.getElementById('takeoffError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('takeoffError').classList.add('hidden');
                }
                if (!acmcReviewYes && !acmcReviewNo) {
                    document.getElementById('acmcReviewError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('acmcReviewError').classList.add('hidden');
                }

                if (!isValid) {
                    document.getElementById('statusMessage').classList.remove('success', 'hidden');
                    document.getElementById('statusMessage').classList.add('error');
                    document.getElementById('statusMessage').textContent = 'Please fill in all required fields and select AC/MC review.';
                    return;
                }

                let total = 0;
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        total += parseInt(checkbox.getAttribute('data-severity') || 0);
                    }
                });
                let riskRank = '';
                let riskNote = '';
                if (total >= 21) {
                    riskRank = 'High';
                    riskNote = 'Call OPS Ofor approval or change mission to bring risk down.';
                } else if (total >= 11) {
                    riskRank = 'Moderate';
                    riskNote = 'Call the CDO to brief mitigation.';
                } else {
                    riskRank = 'Low';
                    riskNote = 'No action required.';
                }

                const maxScore = 81;
                const scorePercentage = (total / maxScore) * 100;
                gaugeFill.style.width = `${scorePercentage}%`;

                const formData = {
                    acmc: acmc,
                    additionalCrew: document.getElementById('additionalCrew').value || '',
                    crew: crew,
                    takeoffTime: takeoffTime,
                    humanFactors: Array.from(checkboxes)
                        .filter(cb => cb.id >= 'q1' && cb.id <= 'q6' && cb.checked)
                        .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                    humanMitigations: document.getElementById('humanMitigations').value.trim() || 'N/A',
                    schedulingFactors: Array.from(checkboxes)
                        .filter(cb => cb.id >= 'q7' && cb.id <= 'q13' && cb.checked)
                        .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                    schedulingMitigations: document.getElementById('schedulingMitigations').value.trim() || 'N/A',
                    missionFactors: Array.from(checkboxes)
                        .filter(cb => cb.id >= 'q14' && cb.id <= 'q22' && cb.checked)
                        .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                    missionMitigations: document.getElementById('missionMitigations').value.trim() || 'N/A',
                    environmentalFactors: Array.from(checkboxes)
                        .filter(cb => cb.id >= 'q23' && cb.id <= 'q27' && cb.checked)
                        .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                    environmentalMitigations: document.getElementById('environmentalMitigations').value.trim() || 'N/A',
                    totalScore: total,
                    riskRank: riskRank,
                    riskNote: riskNote,
                    acmcReview: acmcReviewYes ? 'Yes' : acmcReviewNo ? 'No' : 'Not specified',
                    submissionDate: new Date().toLocaleString()
                };

                document.getElementById('statusMessage').classList.remove('error', 'hidden');
                document.getElementById('statusMessage').classList.add('success');
                document.getElementById('statusMessage').textContent = 'Submitting data via Formspree...';

                fetch('https://formspree.io/f/xnnvlwap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: Object.entries(formData).map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`).join('&'),
                    redirect: 'manual'
                })
                .then(response => {
                    if (response.type === 'opaqueredirect' || response.status === 200) {
                        return { ok: true, text: 'Success' };
                    }
                    if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                    return response.text();
                })
                .then(result => {
                    if (result.ok || (typeof result === 'string' && result.toLowerCase().includes('success'))) {
                        document.getElementById('statusMessage').textContent = 'Data submitted successfully!';
                        totalScoreElement.textContent = total;
                        riskRankElement.textContent = riskRank;
                        riskNoteElement.textContent = riskNote;
                        riskAssessment.classList.remove('hidden');
                    } else {
                        throw new Error('Unexpected response: ' + result);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    document.getElementById('statusMessage').classList.remove('success', 'hidden');
                    document.getElementById('statusMessage').classList.add('error');
                    document.getElementById('statusMessage').textContent = 'Error submitting data: ' + error.message;
                });
            });

            printButton.addEventListener('click', () => {
                console.log('Print button clicked');
                const acmc = document.getElementById('acmc').value.trim();
                const crew = document.getElementById('crew').value;
                const takeoffTime = document.getElementById('takeoffTime').value.trim();
                const acmcReviewYes = document.getElementById('acmcReviewYes').checked;
                const acmcReviewNo = document.getElementById('acmcReviewNo').checked;
                let isValid = true;

                if (!acmc) {
                    document.getElementById('acmcError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('acmcError').classList.add('hidden');
                }
                if (!crew) {
                    document.getElementById('crewError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('crewError').classList.add('hidden');
                }
                if (!takeoffTime) {
                    document.getElementById('takeoffError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('takeoffError').classList.add('hidden');
                }
                if (!acmcReviewYes && !acmcReviewNo) {
                    document.getElementById('acmcReviewError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('acmcReviewError').classList.add('hidden');
                }

                if (!isValid) {
                    document.getElementById('statusMessage').classList.remove('success', 'hidden');
                    document.getElementById('statusMessage').classList.add('error');
                    document.getElementById('statusMessage').textContent = 'Please fill in all required fields and select AC/MC review.';
                    return;
                }

                let total = 0;
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        total += parseInt(checkbox.getAttribute('data-severity') || 0);
                    }
                });
                let riskRank = '';
                let riskNote = '';
                if (total >= 21) {
                    riskRank = 'High';
                    riskNote = 'Call OPS Ofor approval or change mission to bring risk down.';
                } else if (total >= 11) {
                    riskRank = 'Moderate';
                    riskNote = 'Call the CDO to brief mitigation.';
                } else {
                    riskRank = 'Low';
                    riskNote = 'No action required.';
                }

                console.log('Populating printable content');
                const printable = document.getElementById('printable');
                const content = `
                    <h1 style="text-align: center; font-size: 24px; margin-bottom: 1rem;">Operational Risk Management Form - VQ-4 Shadows</h1>
                    <h2 style="font-size: 18px; margin-bottom: 0.5rem;">Flight Information</h2>
                    <p>AC/MC: ${acmc}</p>
                    <p>Crew: ${crew}</p>
                    <p>Takeoff Time: ${takeoffTime}</p>
                    <p>Submission Date: ${new Date().toLocaleString()}</p>

                    <h2 style="font-size: 18px; margin-bottom: 0.5rem;">Human Factors</h2>
                    ${humanFactors.map(factor => {
                        const checked = document.getElementById(factor.id).checked ? '[x]' : '[ ]';
                        return `<p>${checked} ${factor.text} (Severity: ${factor.severity})</p>`;
                    }).join('')}
                    <p>Mitigations: ${document.getElementById('humanMitigations').value.trim().split('\n').join('<br>') || 'N/A'}</p>

                    <h2 style="font-size: 18px; margin-bottom: 0.5rem;">Scheduling & Tempo Factors</h2>
                    ${schedulingFactors.map(factor => {
                        const checked = document.getElementById(factor.id).checked ? '[x]' : '[ ]';
                        return `<p>${checked} ${factor.text} (Severity: ${factor.severity})</p>`;
                    }).join('')}
                    <p>Mitigations: ${document.getElementById('schedulingMitigations').value.trim().split('\n').join('<br>') || 'N/A'}</p>

                    <h2 style="font-size: 18px; margin-bottom: 0.5rem;">Mission Factors</h2>
                    ${missionFactors.map(factor => {
                        const checked = document.getElementById(factor.id).checked ? '[x]' : '[ ]';
                        return `<p>${checked} ${factor.text} (Severity: ${factor.severity})</p>`;
                    }).join('')}
                    <p>Mitigations: ${document.getElementById('missionMitigations').value.trim().split('\n').join('<br>') || 'N/A'}</p>

                    <h2 style="font-size: 18px; margin-bottom: 0.5rem;">Environmental Factors</h2>
                    ${environmentalFactors.map(factor => {
                        const checked = document.getElementById(factor.id).checked ? '[x]' : '[ ]';
                        return `<p>${checked} ${factor.text} (Severity: ${factor.severity})</p>`;
                    }).join('')}
                    <p>Mitigations: ${document.getElementById('environmentalMitigations').value.trim().split('\n').join('<br>') || 'N/A'}</p>

                    <h2 style="font-size: 18px; margin-bottom: 0.5rem;">ACMC Review</h2>
                    <p>Review: ${acmcReviewYes ? 'Yes' : acmcReviewNo ? 'No' : 'Not specified'}</p>

                    <h2 style="font-size: 18px; margin-bottom: 0.5rem;">Risk Assessment</h2>
                    <p>Total Risk Score: ${total}</p>
                    <p>Risk Rank: ${riskRank}</p>
                    <p>Note: ${riskNote}</p>
                `;
                printable.innerHTML = content;
                console.log('Printable content set:', printable.innerHTML);

                // Delay print to ensure content is rendered
                setTimeout(() => {
                    console.log('Triggering print');
                    window.print();
                    document.getElementById('statusMessage').classList.remove('error', 'hidden');
                    document.getElementById('statusMessage').classList.add('success');
                    document.getElementById('statusMessage').textContent = 'Form ready to print or save as PDF!';
                }, 100);
            });
        });
    </script>
    <div id="printable" class="printable"></div>
</body>
</html>