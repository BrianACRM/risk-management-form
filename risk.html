<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operational Risk Management Form - VQ-4 Shadows</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            background-color: #4b5563;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .header-bg {
            background: linear-gradient(135deg, #1e3a8a, #4b5563);
            padding: 20px;
            text-align: center;
            position: relative;
            min-height: 150px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .logo {
            width: 100%;
            max-width: 800px;
            height: auto;
            object-fit: contain;
            border: 2px solid #93c5fd;
            padding: 5px;
            border-radius: 5px;
        }
        .content {
            max-width: 4xl;
            mx-auto;
            bg-gray-800;
            p-8;
            rounded-xl;
            shadow-2xl;
            mt-6;
            flex-grow: 1;
        }
        .input-field:focus {
            border-color: #93c5fd;
            box-shadow: 0 0 8px rgba(147, 197, 253, 0.6);
            transition: all 0.3s ease;
        }
        .status-message {
            display: none;
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: opacity 0.3s ease;
        }
        .success { background-color: #d1fae5; color: #065f46; }
        .error { background-color: #fee2e2; color: #991b1b; }
        .risk-gauge {
            width: 200px;
            height: 20px;
            background: #4b5563;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            transition: all 0.5s ease;
        }
        .gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #facc15, #ef4444);
            width: 0;
            transition: width 0.5s ease;
        }
        .footer {
            background-color: #2d3748;
            width: 100%;
            text-align: center;
            padding: 10px 0;
            margin-top: auto;
        }
        .footer p {
            margin: 0;
            font-size: 0.9rem;
        }
        .footer .contact-button {
            background-color: #1e3a8a;
            color: #ffffff;
            padding: 5px 15px;
            margin-top: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .footer .contact-button:hover {
            background-color: #93c5fd;
        }
        @media (max-width: 640px) {
            .input-field, textarea { font-size: 0.875rem; padding: 0.5rem; }
            .submit-btn, .pdf-btn { width: 100%; margin-bottom: 0.5rem; }
            .status-message { font-size: 0.75rem; }
            h2 { font-size: 1.5rem; }
            .risk-gauge { width: 150px; }
            .header-bg { height: 150px; }
            .logo { padding-top: 30px; }
            .footer {
                padding: 5px 0;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans" style="scroll-behavior: smooth;">
    <header class="header-bg">
        <img src="https://scontent-dfw5-1.xx.fbcdn.net/v/t39.30808-6/474584099_1021247700030529_7719994838169841359_n.jpg?_nc_cat=103&ccb=1-7&_nc_sid=cc71e4&_nc_ohc=EvyCodklsqIQ7kNvwG6Y3Pn&_nc_oc=AdmYohcjVAb99yYaLANFyoihsl50dwUppugeFpgRKJkB3ywLnCHJKROEfbxv39_a__Q&_nc_zt=23&_nc_ht=scontent-dfw5-1.xx&_nc_gid=bS3ZvUasMD0jaTJhAMH1MA&oh=00_AfPahKRnNzkVHkQlAonamRBYvLnm2el3r4oyJqkuxbO3xQ&oe=686B45FA" alt="VQ-4 Banner" class="logo">
    </header>
    <div class="content">
        <div class="bg-gray-700 p-6 rounded-lg mb-6 shadow-inner">
            <p class="text-lg font-medium text-gray-200 leading-relaxed">
                This questionnaire uses the Time Critical ABCD Model to focus the crew, increase situational awareness, and improve performance in the pre-flight and flight environments. Use this questionnaire to Assess the crew, Balance resources, Communicate and then mitigate any assessed risk or decisions, Do the mission with the mitigations in place, and De-brief the mission once completed.<br><br>
                <strong class="text-yellow-300">NOTE:</strong> The use of this questionnaire does not alleviate the requirement to perform deliberate ORM as called out in other instructions and SOPs.
            </p>
        </div>

        <!-- Flight Information -->
        <h2 class="text-2xl font-semibold text-gray-100 mb-4">Flight Information</h2>
        <div class="space-y-6 mb-6">
            <div>
                <label class="block text-lg font-medium text-gray-200" for="acmc">AC/MC <span class="text-red-400">*</span></label>
                <input type="text" id="acmc" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" required>
                <span id="acmcError" class="text-red-400 hidden">AC/MC is required.</span>
            </div>
            <div>
                <label class="block text-lg font-medium text-gray-200" for="additionalCrew">Any Additional Crew Members/Passengers</label>
                <input type="text" id="additionalCrew" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500">
            </div>
            <div>
                <label class="block text-lg font-medium text-gray-200" for="crew">Crew <span class="text-red-400">*</span></label>
                <select id="crew" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" required>
                    <option value="">Choose</option>
                    <option value="LC1">LC1</option>
                    <option value="LC2">LC2</option>
                    <option value="LC3">LC3</option>
                    <option value="LC4">LC4</option>
                    <option value="LC5">LC5</option>
                    <option value="LC6">LC6</option>
                    <option value="LC7">LC7</option>
                    <option value="LC8">LC8</option>
                    <option value="Local">Local</option>
                </select>
                <span id="crewError" class="text-red-400 hidden">Crew is required.</span>
            </div>
            <div>
                <label class="block text-lg font-medium text-gray-200" for="takeoffTime">Scheduled Takeoff Time - Zulu <span class="text-red-400">*</span></label>
                <input type="text" id="takeoffTime" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" required>
                <span id="takeoffError" class="text-red-400 hidden">Takeoff Time is required.</span>
            </div>
        </div>

        <!-- Human Factors -->
        <h2 class="text-2xl font-semibold text-gray-100 mb-4">Human Factors</h2>
        <div class="space-y-2 mb-4">
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q1"> 1. Cumulative fatigue from ≥4 duty days (≥12 hrs/day) in past 5 days</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="3" id="q2"> 2. Cumulative sleep debt (2+ nights w/ <6 hrs sleep in past 72 hrs WHILE being allotted required crew rest time)</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q3"> 3. Circadian rhythm disruption (day ↔ night shift in past 48 hrs)</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="1" id="q4"> 4. Recent personal stressors</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="1" id="q5"> 5. First mission after ≥30-day non-flying period</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q6"> 6. Any Crew Member not current</label><br>
        </div>
        <div class="mb-6">
            <label class="block text-lg font-medium text-gray-200" for="humanMitigations">Mitigations for Selected Human Factors Risks</label>
            <textarea id="humanMitigations" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" rows="3" placeholder="Briefly describe mitigations..."></textarea>
        </div>

        <!-- Scheduling & Tempo Factors -->
        <h2 class="text-2xl font-semibold text-gray-100 mb-4">Scheduling & Tempo Factors</h2>
        <div class="space-y-2 mb-4">
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q7"> 7. Crew rest <12 hours</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q8"> 8. Long sortie (>12 hour planned crew day)</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q9"> 9. Planned crew day includes duty between the hours of 2200-0600</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="3" id="q10"> 10. Projected duty day ≥15 hrs (approaching 18-hour max)</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q11"> 11. Crew scheduled to cross ≥2 time zones in 48-hr period, increasing risk of circadian disruption and fatigue</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q12"> 12. Significant mission change after crew report time requiring re-brief or operational adjustment</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q13"> 13. Crew scheduled without adequate recovery following night mission</label><br>
        </div>
        <div class="mb-6">
            <label class="block text-lg font-medium text-gray-200" for="schedulingMitigations">Mitigations for Selected Scheduling & Tempo Factors Risks</label>
            <textarea id="schedulingMitigations" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" rows="3" placeholder="Briefly describe mitigations..."></textarea>
        </div>

        <!-- Mission Factors -->
        <h2 class="text-2xl font-semibold text-gray-100 mb-4">Mission Factors</h2>
        <div class="space-y-2 mb-4">
            <label><input type="checkbox" class="mr-2" data-severity="1" id="q14"> 14. Op Area evolution</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q15"> 15. Air Refueling</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="3" id="q16"> 16. Pilot Training Event (engine pulls)</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q17"> 17. Closed Tower / Uncontrolled Field Ops</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q18"> 18. R4305 Op Area</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q19"> 19. Unfamiliar Airfield Ops</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="1" id="q20"> 20. Delayed Takeoff (mx, weather, etc...)</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q21"> 21. Known degraded system(s) requiring crew workaround (e.g., comm, nav, radar, ICS)</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="3" id="q22"> 22. Crew augmentation not available despite extended/multi-segment profile</label><br>
        </div>
        <div class="mb-6">
            <label class="block text-lg font-medium text-gray-200" for="missionMitigations">Mitigations for Selected Mission Factors Risks</label>
            <textarea id="missionMitigations" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" rows="3" placeholder="Briefly describe mitigations..."></textarea>
        </div>

        <!-- Environmental Factors -->
        <h2 class="text-2xl font-semibold text-gray-100 mb-4">Environmental Factors</h2>
        <div class="space-y-2 mb-4">
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q23"> 23. Flying at night</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q24"> 24. Departure weather <1500 ft ceiling and/or <3 sm visibility</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="3" id="q25"> 25. Enroute weather concerns (thunderstorms, icing, turbulence)</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q26"> 26. Destination weather <1500 ft ceiling and/or <3 sm visibility</label><br>
            <label><input type="checkbox" class="mr-2" data-severity="2" id="q27"> 27. Elevated bird/wildlife activity at departure/destination field</label><br>
        </div>
        <div class="mb-6">
            <label class="block text-lg font-medium text-gray-200" for="environmentalMitigations">Mitigations for Selected Environmental Factors Risks</label>
            <textarea id="environmentalMitigations" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" rows="3" placeholder="Briefly describe mitigations..."></textarea>
        </div>

        <!-- AC/MC Review Question -->
        <div class="mb-6">
            <label class="block text-lg font-medium text-gray-200">Has the AC/MC reviewed all risk factors and mitigations? <span class="text-red-400">*</span></label>
            <div class="flex items-center space-x-4">
                <label><input type="radio" name="acmcReview" id="acmcReviewYes" value="yes" class="mr-2"> Yes</label>
                <label><input type="radio" name="acmcReview" id="acmcReviewNo" value="no" class="mr-2"> No</label>
            </div>
            <span id="acmcReviewError" class="text-red-400 hidden">AC/MC review (Yes) is required to submit.</span>
        </div>

        <div class="flex space-x-4 mb-6">
            <button id="submitData" class="submit-btn bg-blue-600 text-white p-3 rounded-lg">Submit</button>
            <button id="generatePdf" class="pdf-btn bg-green-600 text-white p-3 rounded-lg">Generate PDF</button>
        </div>
        <div id="statusMessage" class="status-message"></div>
        <div id="riskAssessment" class="mt-6 p-4 bg-gray-700 rounded-lg hidden">
            <h2 class="text-lg font-semibold text-gray-100">Risk Assessment</h2>
            <div class="risk-gauge">
                <div id="gaugeFill" class="gauge-fill"></div>
            </div>
            <p class="mt-2"><strong>Total Risk Score:</strong> <span id="totalScore" class="text-gray-100 font-medium">0</span></p>
            <p><strong>Risk Rank:</strong> <span id="riskRank" class="text-gray-100 font-medium">None</span></p>
            <p id="riskNote" class="mt-2 text-red-400"></p>
        </div>
    </div>
    <div class="footer">
        <p>Any issues or recommendations can be directed to LT Brian Byrd</p>
        <a href="mailto:brian.a.byrd7.mil@us.navy.mil" class="contact-button">Contact LT Byrd</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and script running');
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const totalScoreElement = document.getElementById('totalScore');
            const riskRankElement = document.getElementById('riskRank');
            const riskNoteElement = document.getElementById('riskNote');
            const gaugeFill = document.getElementById('gaugeFill');
            const submitButton = document.getElementById('submitData');
            const generatePdfButton = document.getElementById('generatePdf');

            if (!submitButton || !generatePdfButton) {
                console.error('Submit or Generate PDF button not found:', { submitButton, generatePdfButton });
                return;
            }

            submitButton.addEventListener('click', () => {
                console.log('Submit button clicked');
                const acmc = document.getElementById('acmc').value.trim();
                const crew = document.getElementById('crew').value;
                const takeoffTime = document.getElementById('takeoffTime').value.trim();
                const acmcReviewYes = document.getElementById('acmcReviewYes').checked;
                let isValid = true;

                if (!acmc) {
                    document.getElementById('acmcError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('acmcError').classList.add('hidden');
                }
                if (!crew) {
                    document.getElementById('crewError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('crewError').classList.add('hidden');
                }
                if (!takeoffTime) {
                    document.getElementById('takeoffError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('takeoffError').classList.add('hidden');
                }
                if (!acmcReviewYes) {
                    document.getElementById('acmcReviewError').classList.remove('hidden');
                    isValid = false;
                } else {
                    document.getElementById('acmcReviewError').classList.add('hidden');
                }

                if (!isValid) {
                    document.getElementById('statusMessage').classList.remove('success', 'hidden');
                    document.getElementById('statusMessage').classList.add('error');
                    document.getElementById('statusMessage').textContent = 'Please fill in all required fields and confirm AC/MC review.';
                    return;
                }

                let total = 0;
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        total += parseInt(checkbox.getAttribute('data-severity') || 0);
                    }
                });
                let riskRank = '';
                let riskNote = '';
                if (total >= 21) {
                    riskRank = 'High';
                    riskNote = 'Call OPS Ofor approval or change mission to bring risk down.';
                } else if (total >= 11) {
                    riskRank = 'Moderate';
                    riskNote = 'Call the CDO to brief mitigation.';
                } else {
                    riskRank = 'Low';
                    riskNote = 'No action required.';
                }

                const maxScore = 81;
                const scorePercentage = (total / maxScore) * 100;
                gaugeFill.style.width = `${scorePercentage}%`;

                const formData = {
                    acmc: acmc,
                    additionalCrew: document.getElementById('additionalCrew').value || '',
                    crew: crew,
                    takeoffTime: takeoffTime,
                    humanFactors: Array.from(checkboxes)
                        .filter(cb => cb.id >= 'q1' && cb.id <= 'q6' && cb.checked)
                        .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                    humanMitigations: document.getElementById('humanMitigations').value.trim() || 'N/A',
                    schedulingFactors: Array.from(checkboxes)
                        .filter(cb => cb.id >= 'q7' && cb.id <= 'q13' && cb.checked)
                        .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                    schedulingMitigations: document.getElementById('schedulingMitigations').value.trim() || 'N/A',
                    missionFactors: Array.from(checkboxes)
                        .filter(cb => cb.id >= 'q14' && cb.id <= 'q22' && cb.checked)
                        .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                    missionMitigations: document.getElementById('missionMitigations').value.trim() || 'N/A',
                    environmentalFactors: Array.from(checkboxes)
                        .filter(cb => cb.id >= 'q23' && cb.id <= 'q27' && cb.checked)
                        .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                    environmentalMitigations: document.getElementById('environmentalMitigations').value.trim() || 'N/A',
                    totalScore: total,
                    riskRank: riskRank,
                    riskNote: riskNote,
                    acmcReview: acmcReviewYes ? 'Yes' : 'No',
                    submissionDate: new Date().toISOString()
                };

                document.getElementById('statusMessage').classList.remove('error', 'hidden');
                document.getElementById('statusMessage').classList.add('success');
                document.getElementById('statusMessage').textContent = 'Submitting data via Formspree...';

                fetch('https://formspree.io/f/xnnvlwap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: Object.entries(formData).map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`).join('&'),
                    redirect: 'manual'
                })
                .then(response => {
                    if (response.type === 'opaqueredirect' || response.status === 200) {
                        return { ok: true, text: 'Success' };
                    }
                    if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                    return response.text();
                })
                .then(result => {
                    if (result.ok || (typeof result === 'string' && result.toLowerCase().includes('success'))) {
                        document.getElementById('statusMessage').textContent = 'Data submitted successfully!';
                        totalScoreElement.textContent = total;
                        riskRankElement.textContent = riskRank;
                        riskNoteElement.textContent = riskNote;
                        riskAssessment.classList.remove('hidden');
                    } else {
                        throw new Error('Unexpected response: ' + result);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    document.getElementById('statusMessage').classList.remove('success', 'hidden');
                    document.getElementById('statusMessage').classList.add('error');
                    document.getElementById('statusMessage').textContent = 'Error submitting data: ' + error.message;
                });
            });

            generatePdfButton.addEventListener('click', () => {
                console.log('Generate PDF button clicked');
                const acmc = document.getElementById('acmc').value.trim();
                const crew = document.getElementById('crew').value;
                const takeoffTime = document.getElementById('takeoffTime').value.trim();
                const acmcReviewYes = document.getElementById('acmcReviewYes').checked;
                let isValid = true;

                if (!acmc || !crew || !takeoffTime || !acmcReviewYes) {
                    document.getElementById('statusMessage').classList.remove('success', 'hidden');
                    document.getElementById('statusMessage').classList.add('error');
                    document.getElementById('statusMessage').textContent = 'Please fill in all required fields and confirm AC/MC review to generate PDF.';
                    return;
                }

                let total = 0;
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        total += parseInt(checkbox.getAttribute('data-severity') || 0);
                    } else {
                        console.log(`Unchecked: ${checkbox.id}, severity: ${checkbox.getAttribute('data-severity')}`);
                    }
                });
                console.log('Total calculated:', total);
                let riskRank = '';
                let riskNote = '';
                if (total >= 21) {
                    riskRank = 'High';
                    riskNote = 'Call OPS Ofor approval or change mission to bring risk down.';
                } else if (total >= 11) {
                    riskRank = 'Moderate';
                    riskNote = 'Call the CDO to brief mitigation.';
                } else {
                    riskRank = 'Low';
                    riskNote = 'No action required.';
                }

                const maxScore = 81;
                const scorePercentage = (total / maxScore) * 100;
                gaugeFill.style.width = `${scorePercentage}%`;
                console.log('Risk Rank:', riskRank, 'Total:', total);

                // Generate PDF
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    console.error('jsPDF not loaded');
                    return;
                }
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'in',
                    format: 'a4'
                });
                console.log('jsPDF instance created');

                // Test minimal content
                doc.setFontSize(12);
                doc.text('Test PDF Content', 1, 1); // Simple test text
                console.log('Test text added at 1, 1');

                // Full content if test works
                doc.setFontSize(9);
                const pageWidth = 8.27;
                const leftColumnWidth = 5.5;
                const rightColumnWidth = 2.77;
                const margin = 0.3;

                // Header
                doc.setFillColor(30, 58, 138);
                doc.rect(0, 0, pageWidth, 0.8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text('Operational Risk Management Form - VQ-4 Shadows', pageWidth / 2, 0.4, { align: 'center' });
                console.log('Header drawn');

                // Form Data (Left Column)
                let yOffset = 1.0;
                doc.rect(margin, yOffset - 0.2, leftColumnWidth, 0.2, 'F');
                doc.text('Flight Information', margin + 0.1, yOffset - 0.05);
                yOffset += 0.1;
                doc.text(`AC/MC: ${acmc}`, margin + 0.1, yOffset);
                console.log(`Text added: AC/MC: ${acmc} at y=${yOffset}`);
                yOffset += 0.2;
                doc.text(`Crew: ${crew}`, margin + 0.1, yOffset);
                yOffset += 0.2;
                doc.text(`Takeoff Time: ${takeoffTime}`, margin + 0.1, yOffset);
                yOffset += 0.2;
                doc.text(`Submission Date: ${new Date().toLocaleString()}`, margin + 0.1, yOffset);
                yOffset += 0.3;

                const sections = [
                    { title: 'Human Factors', factors: [
                        { id: 'q1', text: 'Cumulative fatigue from ≥4 duty days (≥12 hrs/day) in past 5 days', severity: 2 },
                        { id: 'q2', text: 'Cumulative sleep debt (2+ nights w/ <6 hrs sleep in past 72 hrs)', severity: 3 },
                        { id: 'q3', text: 'Circadian rhythm disruption (day ↔ night shift in past 48 hrs)', severity: 2 },
                        { id: 'q4', text: 'Recent personal stressors', severity: 1 },
                        { id: 'q5', text: 'First mission after ≥30-day non-flying period', severity: 1 },
                        { id: 'q6', text: 'Any Crew Member not current', severity: 2 }
                    ], mit: 'humanMitigations' },
                    { title: 'Scheduling & Tempo Factors', factors: [
                        { id: 'q7', text: 'Crew rest <12 hours', severity: 2 },
                        { id: 'q8', text: 'Long sortie (>12 hour planned crew day)', severity: 2 },
                        { id: 'q9', text: 'Planned crew day includes duty between 2200-0600', severity: 2 },
                        { id: 'q10', text: 'Projected duty day ≥15 hrs (approaching 18-hour max)', severity: 3 },
                        { id: 'q11', text: 'Crew scheduled to cross ≥2 time zones in 48-hr period', severity: 2 },
                        { id: 'q12', text: 'Significant mission change after crew report time', severity: 2 },
                        { id: 'q13', text: 'Crew scheduled without adequate recovery following night mission', severity: 2 }
                    ], mit: 'schedulingMitigations' },
                    { title: 'Mission Factors', factors: [
                        { id: 'q14', text: 'Op Area evolution', severity: 1 },
                        { id: 'q15', text: 'Air Refueling', severity: 2 },
                        { id: 'q16', text: 'Pilot Training Event (engine pulls)', severity: 3 },
                        { id: 'q17', text: 'Closed Tower / Uncontrolled Field Ops', severity: 2 },
                        { id: 'q18', text: 'R4305 Op Area', severity: 2 },
                        { id: 'q19', text: 'Unfamiliar Airfield Ops', severity: 2 },
                        { id: 'q20', text: 'Delayed Takeoff (mx, weather, etc...)', severity: 1 },
                        { id: 'q21', text: 'Known degraded system(s) requiring crew workaround', severity: 2 },
                        { id: 'q22', text: 'Crew augmentation not available', severity: 3 }
                    ], mit: 'missionMitigations' },
                    { title: 'Environmental Factors', factors: [
                        { id: 'q23', text: 'Flying at night', severity: 2 },
                        { id: 'q24', text: 'Departure weather <1500 ft ceiling and/or <3 sm visibility', severity: 2 },
                        { id: 'q25', text: 'Enroute weather concerns (thunderstorms, icing, turbulence)', severity: 3 },
                        { id: 'q26', text: 'Destination weather <1500 ft ceiling and/or <3 sm visibility', severity: 2 },
                        { id: 'q27', text: 'Elevated bird/wildlife activity at departure/destination field', severity: 2 }
                    ], mit: 'environmentalMitigations' }
                ];

                sections.forEach(section => {
                    doc.rect(margin, yOffset - 0.2, leftColumnWidth, 0.2, 'F');
                    doc.text(section.title, margin + 0.1, yOffset - 0.05);
                    yOffset += 0.1;
                    section.factors.forEach(factor => {
                        const checked = document.getElementById(factor.id).checked;
                        const text = `${factor.text} (Severity: ${factor.severity}, Checked: ${checked ? 'Yes' : 'No'})`;
                        doc.text(text, margin + 0.1, yOffset);
                        console.log(`Added text: ${text} at y=${yOffset}`);
                        yOffset += 0.15;
                    });
                    doc.text(`Mitigations: ${document.getElementById(section.mit).value.trim() || 'N/A'}`, margin + 0.1, yOffset);
                    yOffset += 0.2;
                });
                doc.text(`AC/MC Review: ${acmcReviewYes ? 'Yes' : 'No'}`, margin + 0.1, yOffset);

                // Scoring Matrix (Right Column)
                const matrixX = margin + leftColumnWidth + 0.1;
                let matrixY = 1.0;
                doc.rect(matrixX, matrixY - 0.2, rightColumnWidth, 0.2, 'F');
                doc.text('Scoring Matrix', matrixX + 0.1, matrixY - 0.05);
                matrixY += 0.1;
                doc.text('Severity Levels:', matrixX + 0.1, matrixY);
                matrixY += 0.2;
                doc.text('1 = Low Risk', matrixX + 0.1, matrixY);
                matrixY += 0.15;
                doc.text('2 = Moderate Risk', matrixX + 0.1, matrixY);
                matrixY += 0.15;
                doc.text('3 = High Risk', matrixX + 0.1, matrixY);
                matrixY += 0.2;
                doc.text('Total Score Requirements:', matrixX + 0.1, matrixY);
                matrixY += 0.2;
                doc.text('<11: Low Risk (No action required)', matrixX + 0.1, matrixY);
                matrixY += 0.15;
                doc.text('11-20: Moderate Risk (Call CDO to brief mitigation)', matrixX + 0.1, matrixY);
                matrixY += 0.15;
                doc.text('>21: High Risk (Call OPS for approval or change mission)', matrixX + 0.1, matrixY);
                matrixY += 0.2;
                doc.text(`Current Total: ${total} (${riskRank})`, matrixX + 0.1, matrixY);
                matrixY += 0.2;
                doc.text('Adjust unchecked factors (1-3) and recalculate.', matrixX + 0.1, matrixY);

                console.log('PDF generation completed, saving...');
                doc.save('ORM_Form_Submission.pdf');
            });
        });
    </script>
</body>
</html>