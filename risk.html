<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operational Risk Management Form - VQ-4 Shadows</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        setTimeout(() => {
            if (!window.tailwindcss) {
                console.warn('Primary Tailwind CDN failed, attempting fallback...');
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://unpkg.com/tailwindcss@^2/dist/tailwind.min.js';
                fallbackScript.onload = () => console.log('Tailwind fallback loaded from unpkg');
                fallbackScript.onerror = () => {
                    console.error('Tailwind fallback failed to load, using inline fallback...');
                    const inlineScript = document.createElement('script');
                    inlineScript.textContent = `window.tailwindcss = true;`;
                    document.head.appendChild(inlineScript);
                    console.log('Inline Tailwind fallback applied');
                };
                document.head.appendChild(fallbackScript);
            }
        }, 2000);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #2d3748, #4b5563);
            color: #ffffff;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        .header-bg {
            background: linear-gradient(90deg, #1e3a8a, #3b82f6);
            padding: 1.5rem;
            text-align: center;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: fadeIn 1s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .content {
            max-width: 48rem;
            width: 90%;
            margin: 2rem auto;
            background: rgba(75, 85, 99, 0.9);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .content:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 20px rgba(0, 0, 0, 0.3);
        }
        .section {
            background: #374151;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #3b82f6;
            border-radius: 0.5rem;
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .input-field, textarea {
            width: 100%;
            max-width: 100%;
            padding: 0.75rem;
            border: 2px solid #4b5563;
            border-radius: 0.375rem;
            background-color: #4b5563;
            color: #ffffff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus, textarea:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 8px rgba(96, 165, 250, 0.5);
            outline: none;
        }
        .status-message {
            display: none;
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: opacity 0.3s ease;
        }
        .success { background-color: #d1fae5; color: #065f46; }
        .error { background-color: #fee2e2; color: #991b1b; }
        .risk-gauge {
            width: 200px;
            height: 20px;
            background: #4b5563;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            transition: all 0.5s ease;
        }
        .gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #facc15, #ef4444);
            width: 0;
            transition: width 0.5s ease;
        }
        .footer {
            background-color: #1e293b;
            width: 100%;
            text-align: center;
            padding: 1.5rem 0; /* Increased padding for spacing */
            margin-top: auto;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
        .footer .contact-button {
            background-color: #3b82f6;
            color: #ffffff;
            padding: 0.5rem 1.5rem;
            border-radius: 0.375rem;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .footer .contact-button:hover {
            background-color: #60a5fa;
        }
        @media (max-width: 640px) {
            .header-bg { padding: 1rem; min-height: 80px; }
            .content { margin: 1rem auto; padding: 1rem; width: 95%; }
            .section { padding: 1rem; margin-bottom: 1rem; }
            .input-field, textarea { font-size: 0.875rem; padding: 0.5rem; }
            h2 { font-size: 1.25rem; }
            .risk-gauge { width: 150px; }
            .submit-btn, .pdf-btn { width: 100%; margin-bottom: 0.5rem; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans" style="scroll-behavior: smooth;">
    <header class="header-bg">
        <h1 class="text-4xl font-extrabold text-white">Operational Risk Management Form - VQ-4 Shadows</h1>
    </header>
    <div class="content">
        <div class="section">
            <p class="text-lg font-medium text-gray-200 leading-relaxed">
                This questionnaire uses the Time Critical ABCD Model to focus the crew, increase situational awareness, and improve performance in the pre-flight and flight environments. Use this questionnaire to Assess the crew, Balance resources, Communicate and then mitigate any assessed risk or decisions, Do the mission with the mitigations in place, and De-brief the mission once completed.<br><br>
                <strong class="text-yellow-300">NOTE:</strong> The use of this questionnaire does not alleviate the requirement to perform deliberate ORM as called out in other instructions and SOPs.
            </p>
        </div>

        <div class="section">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Flight Information</h2>
            <div class="space-y-6 mb-6">
                <div class="flex items-center space-x-4 mb-4">
                    <label class="block text-lg font-medium text-gray-200 w-1/3" for="acmc">AC/MC <span class="text-red-400">*</span></label>
                    <input type="text" id="acmc" class="w-2/3 p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" required>
                    <span id="acmcError" class="text-red-400 hidden">AC/MC is required.</span>
                </div>
                <div class="flex items-center space-x-4 mb-4">
                    <label class="block text-lg font-medium text-gray-200 w-1/3" for="additionalCrew">Any Additional Crew Members/Passengers</label>
                    <input type="text" id="additionalCrew" class="w-2/3 p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500">
                </div>
                <div class="flex items-center space-x-4 mb-4">
                    <label class="block text-lg font-medium text-gray-200 w-1/3" for="crew">Crew <span class="text-red-400">*</span></label>
                    <select id="crew" class="w-2/3 p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" required>
                        <option value="">Choose</option>
                        <option value="LC1">LC1</option>
                        <option value="LC2">LC2</option>
                        <option value="LC3">LC3</option>
                        <option value="LC4">LC4</option>
                        <option value="LC5">LC5</option>
                        <option value="LC6">LC6</option>
                        <option value="LC7">LC7</option>
                        <option value="LC8">LC8</option>
                        <option value="Local">Local</option>
                    </select>
                    <span id="crewError" class="text-red-400 hidden">Crew is required.</span>
                </div>
                <div class="flex items-center space-x-4 mb-4">
                    <label class="block text-lg font-medium text-gray-200 w-1/3" for="takeoffTime">Scheduled Takeoff Time - Zulu <span class="text-red-400">*</span></label>
                    <input type="text" id="takeoffTime" class="w-2/3 p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" required>
                    <span id="takeoffError" class="text-red-400 hidden">Takeoff Time is required.</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Human Factors</h2>
            <div class="space-y-2 mb-4">
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q1"> 1. Cumulative fatigue from ≥4 duty days (≥12 hrs/day) in past 5 days</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="3" id="q2"> 2. Cumulative sleep debt (2+ nights w/ <6 hrs sleep in past 72 hrs WHILE being allotted required crew rest time)</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q3"> 3. Circadian rhythm disruption (day ↔ night shift in past 48 hrs)</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="1" id="q4"> 4. Recent personal stressors</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="1" id="q5"> 5. First mission after ≥30-day non-flying period</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q6"> 6. Any Crew Member not current</label><br>
            </div>
            <div class="mb-6">
                <textarea id="humanMitigations" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" rows="3" placeholder="Briefly describe mitigations..."></textarea>
            </div>
        </div>

        <div class="section">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Scheduling & Tempo Factors</h2>
            <div class="space-y-2 mb-4">
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q7"> 7. Crew rest <12 hours</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q8"> 8. Long sortie (>12 hour planned crew day)</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q9"> 9. Planned crew day includes duty between the hours of 2200-0600</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="3" id="q10"> 10. Projected duty day ≥15 hrs (approaching 18-hour max)</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q11"> 11. Crew scheduled to cross ≥2 time zones in 48-hr period, increasing risk of circadian disruption and fatigue</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q12"> 12. Significant mission change after crew report time requiring re-brief or operational adjustment</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q13"> 13. Crew scheduled without adequate recovery following night mission</label><br>
            </div>
            <div class="mb-6">
                <textarea id="schedulingMitigations" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" rows="3" placeholder="Briefly describe mitigations..."></textarea>
            </div>
        </div>

        <div class="section">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Mission Factors</h2>
            <div class="space-y-2 mb-4">
                <label><input type="checkbox" class="mr-2" data-severity="1" id="q14"> 14. Op Area evolution</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q15"> 15. Air Refueling</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="3" id="q16"> 16. Pilot Training Event (engine pulls)</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q17"> 17. Closed Tower / Uncontrolled Field Ops</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q18"> 18. R4305 Op Area</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q19"> 19. Unfamiliar Airfield Ops</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="1" id="q20"> 20. Delayed Takeoff (mx, weather, etc...)</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q21"> 21. Known degraded system(s) requiring crew workaround (e.g., comm, nav, radar, ICS)</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="3" id="q22"> 22. Crew augmentation not available despite extended/multi-segment profile</label><br>
            </div>
            <div class="mb-6">
                <textarea id="missionMitigations" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" rows="3" placeholder="Briefly describe mitigations..."></textarea>
            </div>
        </div>

        <div class="section">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Environmental Factors</h2>
            <div class="space-y-2 mb-4">
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q23"> 23. Flying at night</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q24"> 24. Departure weather <1500 ft ceiling and/or <3 sm visibility</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="3" id="q25"> 25. Enroute weather concerns (thunderstorms, icing, turbulence)</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q26"> 26. Destination weather <1500 ft ceiling and/or <3 sm visibility</label><br>
                <label><input type="checkbox" class="mr-2" data-severity="2" id="q27"> 27. Elevated bird/wildlife activity at departure/destination field</label><br>
            </div>
            <div class="mb-6">
                <textarea id="environmentalMitigations" class="w-full p-3 border rounded-lg input-field bg-gray-600 text-white border-gray-500" rows="3" placeholder="Briefly describe mitigations..."></textarea>
            </div>
        </div>

        <div class="section">
            <label class="block text-lg font-medium text-gray-200">Has the AC/MC reviewed all risk factors and mitigations? <span class="text-red-400">*</span></label>
            <div class="flex items-center space-x-4 mt-2">
                <label><input type="radio" name="acmcReview" id="acmcReviewYes" value="yes" class="mr-2"> Yes</label>
                <label><input type="radio" name="acmcReview" id="acmcReviewNo" value="no" class="mr-2"> No</label>
            </div>
            <span id="acmcReviewError" class="text-red-400 hidden">AC/MC review (Yes) is required to submit.</span>
        </div>

        <div class="flex space-x-4 mb-6 mt-4">
            <button id="submitData" class="submit-btn bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition duration-300 ease-in-out">Submit</button>
            <button id="generatePdf" class="pdf-btn bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg transition duration-300 ease-in-out">Generate PDF</button>
        </div>
        <div id="statusMessage" class="status-message"></div>
        <div id="riskAssessment" class="mt-6 p-4 bg-gray-700 rounded-lg hidden">
            <h2 class="text-lg font-semibold text-gray-100">Risk Assessment</h2>
            <div class="risk-gauge">
                <div id="gaugeFill" class="gauge-fill"></div>
            </div>
            <p class="mt-2"><strong>Total Risk Score:</strong> <span id="totalScore" class="text-gray-100 font-medium">0</span></p>
            <p><strong>Risk Rank:</strong> <span id="riskRank" class="text-gray-100 font-medium">None</span></p>
            <p id="riskNote" class="mt-2 text-red-400"></p>
        </div>
    </div>
    <div class="footer">
    <p class="mb-2">Any issues or recommendations can be directed to LT Brian 'DoDo' Byrd</p>
    <a href="mailto:brian.a.byrd7.mil@us.navy.mil" class="contact-button">Contact</a>
</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM fully loaded and script running');
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const totalScoreElement = document.getElementById('totalScore');
        const riskRankElement = document.getElementById('riskRank');
        const riskNoteElement = document.getElementById('riskNote');
        const gaugeFill = document.getElementById('gaugeFill');
        const submitButton = document.getElementById('submitData');
        const generatePdfButton = document.getElementById('generatePdf');

        if (!submitButton || !generatePdfButton) {
            console.error('Submit or Generate PDF button not found:', { submitButton, generatePdfButton });
            return;
        }

        submitButton.addEventListener('click', () => {
            console.log('Submit button clicked');
            const acmc = document.getElementById('acmc').value.trim();
            const crew = document.getElementById('crew').value;
            const takeoffTime = document.getElementById('takeoffTime').value.trim();
            const acmcReviewYes = document.getElementById('acmcReviewYes').checked;
            let isValid = true;

            if (!acmc) {
                document.getElementById('acmcError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('acmcError').classList.add('hidden');
            }
            if (!crew) {
                document.getElementById('crewError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('crewError').classList.add('hidden');
            }
            if (!takeoffTime) {
                document.getElementById('takeoffError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('takeoffError').classList.add('hidden');
            }
            if (!acmcReviewYes) {
                document.getElementById('acmcReviewError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('acmcReviewError').classList.add('hidden');
            }

            if (!isValid) {
                document.getElementById('statusMessage').classList.remove('success', 'hidden');
                document.getElementById('statusMessage').classList.add('error');
                document.getElementById('statusMessage').textContent = 'Please fill in all required fields and confirm AC/MC review.';
                return;
            }

            let total = 0;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    total += parseInt(checkbox.getAttribute('data-severity') || 0);
                }
            });
            let riskRank = '';
            let riskNote = '';
            if (total >= 21) {
                riskRank = 'High';
                riskNote = 'Call OPS Ofor approval or change mission to bring risk down.';
            } else if (total >= 11) {
                riskRank = 'Moderate';
                riskNote = 'Call the CDO to brief mitigation.';
            } else {
                riskRank = 'Low';
                riskNote = 'No action required.';
            }

            const maxScore = 81;
            const scorePercentage = (total / maxScore) * 100;
            gaugeFill.style.width = `${scorePercentage}%`;

            const formData = {
                acmc: acmc,
                additionalCrew: document.getElementById('additionalCrew').value || '',
                crew: crew,
                takeoffTime: takeoffTime,
                humanFactors: Array.from(checkboxes)
                    .filter(cb => cb.id >= 'q1' && cb.id <= 'q6' && cb.checked)
                    .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                humanMitigations: document.getElementById('humanMitigations').value.trim() || 'N/A',
                schedulingFactors: Array.from(checkboxes)
                    .filter(cb => cb.id >= 'q7' && cb.id <= 'q13' && cb.checked)
                    .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                schedulingMitigations: document.getElementById('schedulingMitigations').value.trim() || 'N/A',
                missionFactors: Array.from(checkboxes)
                    .filter(cb => cb.id >= 'q14' && cb.id <= 'q22' && cb.checked)
                    .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                missionMitigations: document.getElementById('missionMitigations').value.trim() || 'N/A',
                environmentalFactors: Array.from(checkboxes)
                    .filter(cb => cb.id >= 'q23' && cb.id <= 'q27' && cb.checked)
                    .map(cb => cb.nextSibling.textContent.trim()).join(', ') || 'None',
                environmentalMitigations: document.getElementById('environmentalMitigations').value.trim() || 'N/A',
                totalScore: total,
                riskRank: riskRank,
                riskNote: riskNote,
                acmcReview: acmcReviewYes ? 'Yes' : 'No',
                submissionDate: new Date().toLocaleString()
            };

            document.getElementById('statusMessage').classList.remove('error', 'hidden');
            document.getElementById('statusMessage').classList.add('success');
            document.getElementById('statusMessage').textContent = 'Submitting data via Formspree...';

            fetch('https://formspree.io/f/xnnvlwap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: Object.entries(formData).map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`).join('&'),
                redirect: 'manual'
            })
            .then(response => {
                if (response.type === 'opaqueredirect' || response.status === 200) {
                    return { ok: true, text: 'Success' };
                }
                if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                return response.text();
            })
            .then(result => {
                if (result.ok || (typeof result === 'string' && result.toLowerCase().includes('success'))) {
                    document.getElementById('statusMessage').textContent = 'Data submitted successfully!';
                    totalScoreElement.textContent = total;
                    riskRankElement.textContent = riskRank;
                    riskNoteElement.textContent = riskNote;
                    riskAssessment.classList.remove('hidden');
                } else {
                    throw new Error('Unexpected response: ' + result);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                document.getElementById('statusMessage').classList.remove('success', 'hidden');
                document.getElementById('statusMessage').classList.add('error');
                document.getElementById('statusMessage').textContent = 'Error submitting data: ' + error.message;
            });
        });

        generatePdfButton.addEventListener('click', () => {
            console.log('Generate PDF button clicked');
            const acmc = document.getElementById('acmc').value.trim();
            const crew = document.getElementById('crew').value;
            const takeoffTime = document.getElementById('takeoffTime').value.trim();
            const acmcReviewYes = document.getElementById('acmcReviewYes').checked;
            let isValid = true;

            if (!acmc || !crew || !takeoffTime || !acmcReviewYes) {
                document.getElementById('statusMessage').classList.remove('success', 'hidden');
                document.getElementById('statusMessage').classList.add('error');
                document.getElementById('statusMessage').textContent = 'Please fill in all required fields and confirm AC/MC review to generate PDF.';
                return;
            }

            // Validate takeoff time (simple check for HHMM format)
            const timeRegex = /^([0-1]?[0-9]|2[0-3])[0-5][0-9]$/;
            if (!timeRegex.test(takeoffTime.replace(/:/g, ''))) {
                document.getElementById('statusMessage').classList.remove('success', 'hidden');
                document.getElementById('statusMessage').classList.add('error');
                document.getElementById('statusMessage').textContent = 'Invalid Takeoff Time format. Use HH:MM (e.g., 12:00).';
                return;
            }

            let total = 0;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    total += parseInt(checkbox.getAttribute('data-severity') || 0);
                }
            });
            let riskRank = '';
            let riskNote = '';
            if (total >= 21) {
                riskRank = 'High';
                riskNote = 'Call OPS Ofor approval or change mission to bring risk down.';
            } else if (total >= 11) {
                riskRank = 'Moderate';
                riskNote = 'Call the CDO to brief mitigation.';
            } else {
                riskRank = 'Low';
                riskNote = 'No action required.';
            }

            const maxScore = 81;
            const scorePercentage = (total / maxScore) * 100;
            gaugeFill.style.width = `${scorePercentage}%`;
            console.log('Risk Rank:', riskRank, 'Total:', total);

            // Generate PDF
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                console.error('jsPDF not loaded');
                return;
            }
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'in',
                format: 'a4'
            });
            console.log('jsPDF instance created');

            // Header
            doc.setFillColor(30, 58, 138);
            doc.rect(0, 0, 8.27, 0.8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.text('Operational Risk Management Form - VQ-4 Shadows', 4.135, 0.4, { align: 'center' });
            console.log('Header drawn');
            doc.setTextColor(0, 0, 0);

            // Flight Information
            let yOffset = 1.0;
            doc.setFillColor(240, 240, 240);
            doc.rect(0.5, yOffset - 0.2, 7.27, 0.2, 'F');
            doc.setFontSize(12);
            doc.text('Flight Information', 0.6, yOffset);
            yOffset += 0.2;
            doc.setFontSize(10);
            doc.text(`AC/MC: ${acmc}`, 0.6, yOffset);
            yOffset += 0.2;
            doc.text(`Crew: ${crew}`, 0.6, yOffset);
            yOffset += 0.2;
            doc.text(`Takeoff Time: ${takeoffTime}Z`, 0.6, yOffset); // Added 'Z' for Zulu
            yOffset += 0.2;
            doc.text(`Submission Date: ${new Date().toLocaleString()}`, 0.6, yOffset);
            yOffset += 0.3;

            // Human Factors
            doc.setFillColor(240, 240, 240);
            doc.rect(0.5, yOffset - 0.2, 7.27, 0.2, 'F');
            doc.setFontSize(12);
            doc.text('Human Factors', 0.6, yOffset);
            yOffset += 0.2;
            doc.setFontSize(10);
            const humanFactors = [
                { id: 'q1', text: 'Cumulative fatigue from ≥4 duty days (≥12 hrs/day) in past 5 days', severity: 2 },
                { id: 'q2', text: 'Cumulative sleep debt (2+ nights w/ <6 hrs sleep in past 72 hrs)', severity: 3 },
                { id: 'q3', text: 'Circadian rhythm disruption (day ↔ night shift in past 48 hrs)', severity: 2 },
                { id: 'q4', text: 'Recent personal stressors', severity: 1 },
                { id: 'q5', text: 'First mission after ≥30-day non-flying period', severity: 1 },
                { id: 'q6', text: 'Any Crew Member not current', severity: 2 }
            ];
            humanFactors.forEach(factor => {
                const checked = document.getElementById(factor.id).checked ? '[x]' : '[ ]';
                doc.text(`${checked} ${factor.text} (Severity: ${factor.severity})`, 0.6, yOffset);
                yOffset += 0.2;
            });
            doc.text(`Mitigations: ${document.getElementById('humanMitigations').value.trim() || 'N/A'}`, 0.6, yOffset);
            yOffset += 0.2;

            // Scheduling & Tempo Factors
            doc.setFillColor(240, 240, 240);
            doc.rect(0.5, yOffset - 0.2, 7.27, 0.2, 'F');
            doc.setFontSize(12);
            doc.text('Scheduling & Tempo Factors', 0.6, yOffset);
            yOffset += 0.2;
            doc.setFontSize(10);
            const schedulingFactors = [
                { id: 'q7', text: 'Crew rest <12 hours', severity: 2 },
                { id: 'q8', text: 'Long sortie (>12 hour planned crew day)', severity: 2 },
                { id: 'q9', text: 'Planned crew day includes duty between 2200-0600', severity: 2 },
                { id: 'q10', text: 'Projected duty day ≥15 hrs (approaching 18-hour max)', severity: 3 },
                { id: 'q11', text: 'Crew scheduled to cross ≥2 time zones in 48-hr period', severity: 2 },
                { id: 'q12', text: 'Significant mission change after crew report time', severity: 2 },
                { id: 'q13', text: 'Crew scheduled without adequate recovery following night mission', severity: 2 }
            ];
            schedulingFactors.forEach(factor => {
                const checked = document.getElementById(factor.id).checked ? '[x]' : '[ ]';
                doc.text(`${checked} ${factor.text} (Severity: ${factor.severity})`, 0.6, yOffset);
                yOffset += 0.2;
            });
            doc.text(`Mitigations: ${document.getElementById('schedulingMitigations').value.trim() || 'N/A'}`, 0.6, yOffset);
            yOffset += 0.2;

            // Mission Factors
            doc.setFillColor(240, 240, 240);
            doc.rect(0.5, yOffset - 0.2, 7.27, 0.2, 'F');
            doc.setFontSize(12);
            doc.text('Mission Factors', 0.6, yOffset);
            yOffset += 0.2;
            doc.setFontSize(10);
            const missionFactors = [
                { id: 'q14', text: 'Op Area evolution', severity: 1 },
                { id: 'q15', text: 'Air Refueling', severity: 2 },
                { id: 'q16', text: 'Pilot Training Event (engine pulls)', severity: 3 },
                { id: 'q17', text: 'Closed Tower / Uncontrolled Field Ops', severity: 2 },
                { id: 'q18', text: 'R4305 Op Area', severity: 2 },
                { id: 'q19', text: 'Unfamiliar Airfield Ops', severity: 2 },
                { id: 'q20', text: 'Delayed Takeoff (mx, weather, etc...)', severity: 1 },
                { id: 'q21', text: 'Known degraded system(s) requiring crew workaround', severity: 2 },
                { id: 'q22', text: 'Crew augmentation not available', severity: 3 }
            ];
            missionFactors.forEach(factor => {
                const checked = document.getElementById(factor.id).checked ? '[x]' : '[ ]';
                doc.text(`${checked} ${factor.text} (Severity: ${factor.severity})`, 0.6, yOffset);
                yOffset += 0.2;
            });
            doc.text(`Mitigations: ${document.getElementById('missionMitigations').value.trim() || 'N/A'}`, 0.6, yOffset);
            yOffset += 0.2;

            // Environmental Factors
            doc.setFillColor(240, 240, 240);
            doc.rect(0.5, yOffset - 0.2, 7.27, 0.2, 'F');
            doc.setFontSize(12);
            doc.text('Environmental Factors', 0.6, yOffset);
            yOffset += 0.2;
            doc.setFontSize(10);
            const environmentalFactors = [
                { id: 'q23', text: 'Flying at night', severity: 2 },
                { id: 'q24', text: 'Departure weather <1500 ft ceiling and/or <3 sm visibility', severity: 2 },
                { id: 'q25', text: 'Enroute weather concerns (thunderstorms, icing, turbulence)', severity: 3 },
                { id: 'q26', text: 'Destination weather <1500 ft ceiling and/or <3 sm visibility', severity: 2 },
                { id: 'q27', text: 'Elevated bird/wildlife activity at departure/destination field', severity: 2 }
            ];
            environmentalFactors.forEach(factor => {
                const checked = document.getElementById(factor.id).checked ? '[x]' : '[ ]';
                doc.text(`${checked} ${factor.text} (Severity: ${factor.severity})`, 0.6, yOffset);
                yOffset += 0.2;
            });
            doc.text(`Mitigations: ${document.getElementById('environmentalMitigations').value.trim() || 'N/A'}`, 0.6, yOffset);
            yOffset += 0.2;

            // ACMC Review
            doc.setFillColor(240, 240, 240);
            doc.rect(0.5, yOffset - 0.2, 7.27, 0.2, 'F');
            doc.setFontSize(12);
            doc.text('ACMC Review', 0.6, yOffset);
            yOffset += 0.2;
            doc.setFontSize(10);
            doc.text(`Review: ${acmcReviewYes ? 'Yes' : 'No'}`, 0.6, yOffset);
            yOffset += 0.2;

            // Risk Assessment
            doc.setFillColor(240, 240, 240);
            doc.rect(0.5, yOffset - 0.2, 7.27, 0.2, 'F');
            doc.setFontSize(12);
            doc.text('Risk Assessment', 0.6, yOffset);
            yOffset += 0.2;
            doc.setFontSize(10);
            doc.text(`Total Risk Score: ${total}`, 0.6, yOffset);
            yOffset += 0.2;
            doc.text(`Risk Rank: ${riskRank}`, 0.6, yOffset);
            yOffset += 0.2;
            doc.text(`Note: ${riskNote}`, 0.6, yOffset);

            console.log('PDF generation completed, saving...');
            doc.save('ORM_Form_Submission.pdf');
        });
    </script>
</body>
</html>